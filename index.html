<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Диаграмма с авторасширением</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
          integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Верхняя панель -->
<div id="toolbar">

    <!-- Работа с проектом -->
    <div class="group">
        <button title="Новый проект" id="newProject"><i class="far fa-file"></i></button>
        <button title="Сохранить проект" id="saveProject"><i class="fas fa-floppy-disk"></i></button>
        <button title="Открыть проект" id="loadProject"><i class="fas fa-folder-open"></i></button>
        <button title="Удалить проект" id="deleteProject"><i class="fas fa-trash"></i></button>
    </div>

    <div class="separator"></div>

    <!-- Undo/Redo и масштаб -->
    <div class="group">
        <button title="Undo" id="undo" class="disabled"><i class="fas fa-undo"></i></button>
        <button title="Redo" id="redo" class="disabled"><i class="fas fa-redo"></i></button>
        <button title="Увеличить масштаб" id="zoomIn"><i class="fa fa-search-plus" aria-hidden="true"></i></button>
        <button title="Уменьшить масштаб" id="zoomOut"><i class="fa fa-search-minus" aria-hidden="true"></i></button>
        <button title="Сброс масштаба" id="zoomReset" class="disabled"><i class="fa fa-search" aria-hidden="true"></i></button>
    </div>

    <div class="separator"></div>

    <!-- Добавление -->
    <div class="group">
        <button title="Добавить таблицу" id="addBlock"><i class="fas fa-plus"></i></button>
        <button title="Добавить таблицу" id="editProperty"><i class="fa fa-file-text-o" aria-hidden="true"></i></button>
        <button title="Удалить обьект" id="removeObject" class="disabled"><i class="fa fa-times" aria-hidden="true"></i></button>
    </div>

    <div class="separator"></div>

    <div class="group">
        <button title="Показать сетку" id="toggleGrid"><i class="fas fa-border-all"></i></button>
        <button title="Прилипание к сетке" id="toggleSnap" class="active"><i class="fas fa-magnet"></i></button>
    </div>
</div>

<div id="main">
    <div id="workspace">
        <div id="canvas">
            <svg id="connections">
                <defs>
                    <!-- воронья лапка (N) -->
                    <marker id="many" class="marker-relation" markerWidth="14" markerHeight="14" refX="13" refY="7"
                            orient="auto" markerUnits="strokeWidth">
                        <path d="M13,0 L1,7 L13,14" stroke="gray" stroke-width="1" fill="none"/>
                    </marker>

                    <marker id="many-start" class="marker-relation" markerWidth="14" markerHeight="14" refX="0" refY="7"
                            orient="auto" markerUnits="strokeWidth">
                        <path d="M0,0 L13,7 L0,13" stroke="gray" stroke-width="1" fill="none"/>
                    </marker>
                </defs>
            </svg>
        </div>
    </div>

    <div id="splitter"></div>

    <div id="inspector">

    </div>
</div>

<!-- шаблон заголовка для инспектора -->
<template id="inspector-title-template">
    <div class="inspector-title model-list">
        <div class="left">
            <button class="back-btn" title="Вернуться к списку">←</button>
            <span class="title-text">Модель</span>
        </div>
        <span class="subtitle">properties</span>
    </div>
</template>

<template id="inspector-model-list">
    <div class="inspector-title property">
        <div class="left">
            <span class="title-text">Список обьектов</span>
        </div>
        <span class="subtitle">list</span>
    </div>
</template>


<script src="js/variables.js"></script>
<script src="js/model-name.js"></script>

<script>

    //*******************************************************
    //                     Создание блока                  //
    //*******************************************************
    function createBlock(data = null) {

        const block = document.createElement("div");

        block.className = "block";
        block.style.top = (data?.top || 50) + "px";
        block.style.left = (data?.left || 50) + "px";
        // Присваиваем уникальный UUID
        block.dataset.id = data?.id || generateUUID();

        const uniqueName = getUniqueDefaultName("Model");
        const name = data?.title || uniqueName;

        block.innerHTML = `
      <div class="block-header">
        <span class="title">${name}</span>
        <span class="delete-block">×</span>
      </div>
      <ul class="fields">
        ${(data?.fields || ["id INT", "name VARCHAR"]).map(f => {
            const [name, type] = f.split(" ");
            return `<li data-field-name="${name}" data-block-id="${block.dataset.id}"><span>${name}</span><span>${type}</span></li>`;
        }).join("")}
      </ul>
      <button class="add-field">+ Добавить поле</button>
    `;

        canvas.appendChild(block);

        block.x = block.offsetLeft;
        block.y = block.offsetTop;
        block.title = name;

        let title = block.querySelector(".title");

        title.title = "Для редактирования имени - двойной клик";

        block.querySelector(".delete-block").onclick = () => {
            if (confirm("Удалить обьект?")) {
                block.remove();
                updateAllConnections();
                saveState();
                inspector.showModelList();
            }
        };

        // block.querySelector(".add-field").onclick = () => {
        //     const li = document.createElement("li");
        //     li.innerHTML = "<span>new_field</span><span>INT</span>";
        //     block.querySelector(".fields").appendChild(li);
        //     attachFieldEvents(li);
        //     saveState();
        // };
        //
        title.parentElement.ondblclick = () => enableEditing(title, block);

        // ------------------- Перетаскивание блока -------------------
        let header = block.querySelector(".block-header");

        header.onmousedown = e => {
            if (e.shiftKey) {
                //startFieldConnection(block, e);
            } else {
                startDragging(block, e);
            }
        };

        [...block.querySelectorAll("li")].forEach(attachFieldEvents);

        adjustCanvasSize();

        inspector.showModelList();
    }

    //*******************************************************
    //                   Перетаскивание                    //
    //*******************************************************
    function startDragging(block, e) {
        let isChange = false;
        let startX = e.clientX;
        let startY = e.clientY;

        // Вызывается при перемещении блока
        function onMouseMove(ev) {
            isChange = true;
            const dx = ev.clientX - startX;
            const dy = ev.clientY - startY;

            block.x += dx;
            block.y += dy;

            block.x = block.x < 10 ? 10 : block.x;
            block.y = block.y < 10 ? 10 : block.y;

            // Привязка к сетке
            if(snapToGrid) {
               // block.x = Math.round(block.x / gridSize) * gridSize;
                //block.y = Math.round(block.y / gridSize) * gridSize;

                const threshold = 4; // пикселей

                const x = Math.round(block.x / gridSize) * gridSize;
                if (Math.abs(x - block.x) < threshold) {
                    block.x = x;
                }

                const y = Math.round(block.y / gridSize) * gridSize;
                if (Math.abs(y - block.y) < threshold) {
                    block.y = y;
                }
            }

            block.style.left = block.x + "px";
            block.style.top = block.y + "px";

            startX = ev.clientX;
            startY = ev.clientY;

            adjustCanvasSize();
            updateAllConnections();
        }

        document.addEventListener("mousemove", onMouseMove);

        document.onmouseup = () => {
            document.removeEventListener("mousemove", onMouseMove);
            document.onmouseup = null;
            //saveState();
            if(isChange) {
                saveDraft();
                isChange = false;
            }
        };
    }

    //********************************************************
    //             События полей для соединения             //
    //********************************************************
    function attachFieldEvents(li) {

        li.onmousedown = e => {

            if (e.shiftKey) {

                startFieldConnection(li, e);

                e.preventDefault();
            }
        };
    }

    // ------------ Начало соединения поля ------------------
    function startFieldConnection(li, e) {
        connecting = li;
        tempLine = document.createElementNS("http://www.w3.org/2000/svg", "path");
        tempLine.setAttribute("stroke", "gray");
        tempLine.setAttribute("stroke-width", "1");
        tempLine.setAttribute("fill", "none");
        tempLine.setAttribute("stroke-dasharray", "5,5");
        svgContainer.appendChild(tempLine);
        document.addEventListener("mousemove", onTempLineMoveField); // рисуем временную линию
        document.addEventListener("mouseup", onTempLineEndField);    // кнопка отпущена - фиксируем результат
    }

    function onTempLineMoveField(e) {
        if (!connecting) return;

        const zoom = zoomLevel || 1;

        const a = connecting.getBoundingClientRect();
        const cs = canvas.getBoundingClientRect();

        // Преобразуем координаты с учетом масштаба
        const x1 = (a.right - cs.left) / zoom;
        const y1 = (a.top + a.height / 2 - cs.top) / zoom;
        const x2 = (e.clientX - cs.left) / zoom;
        const y2 = (e.clientY - cs.top) / zoom;

        const midX = (x1 + x2) / 2;
        tempLine.setAttribute("d", `M${x1},${y1} L${midX},${y1} L${midX},${y2} L${x2},${y2}`);
    }

    // ------------------- Завершение соединения -------------------
    function onTempLineEndField(e) {
        if (!connecting) return;
        const target = document.elementFromPoint(e.clientX, e.clientY);
        const targetLi = target.closest("li");
        if (targetLi && targetLi !== connecting) {
            connectFields(connecting, targetLi);
            saveConnections();
        }
        tempLine.remove();
        tempLine = null;
        connecting = null;
        document.removeEventListener("mousemove", onTempLineMoveField);
        document.removeEventListener("mouseup", onTempLineEndField);
    }

    // ------------------- Создание постоянной линии -------------------
    function connectFields(fromLi, toLi, type = "one-to-many") {
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("stroke", "gray");
        path.setAttribute("stroke-width", "1");
        path.setAttribute("fill", "none");
        path.setAttribute("marker-start", "url(#many-start)");
        path.setAttribute("marker-end", "url(#many)");
        svgContainer.appendChild(path);

        // хит-зона — невидимая линия для удобного наведения
        const hitPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        hitPath.setAttribute("stroke", "transparent");
        hitPath.setAttribute("stroke-width", "8"); // удобная зона
        hitPath.setAttribute("fill", "none");
        hitPath.setAttribute("pointer-events", "stroke"); // чтобы ловила события
        svgContainer.appendChild(hitPath);

        // удаление связи по клику
        hitPath.addEventListener("click", () => {
            if (confirm("Удалить связь?")) {
                const idx = connections.findIndex(c => c.path === path);
                if (idx !== -1) {
                    connections[idx].path.remove();         // убрать из DOM
                    connections[idx].hitPath.remove();
                    connections.splice(idx, 1);  // убрать из массива
                    saveConnections();                      // обновить хранилище
                }
            }
        });

        hitPath.addEventListener("mouseenter", () => {
            //path.setAttribute("stroke", "tomato");
            path.setAttribute("stroke", "#666");
            path.setAttribute("stroke-width", "2")
        });
        hitPath.addEventListener("mouseleave", () => {
            path.setAttribute("stroke", "gray");
            path.setAttribute("stroke-width", "1")
        });

        const rel = {from: fromLi, to: toLi, path, hitPath};
        connections.push(rel);

        updateConnection(rel);
    }

    // ------------------- Обновление линии -------------------
    function updateConnection(rel) {
        const svg = document.getElementById('connections');
        const canvas = document.getElementById('canvas');

        // Подгоняем SVG под canvas
        const width = canvas.offsetWidth;
        const height = canvas.offsetHeight;
        svg.setAttribute('width', width);
        svg.setAttribute('height', height);
        svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

        // Получаем координаты li через getBoundingClientRect
        const zoom = zoomLevel;

        const aRect = rel.from.getBoundingClientRect();
        const bRect = rel.to.getBoundingClientRect();
        const canvasRect = canvas.getBoundingClientRect();

        const x1 = (aRect.right - canvasRect.left) / zoom;
        const y1 = (aRect.top + aRect.height / 2 - canvasRect.top) / zoom;

        const x2 = (bRect.left - canvasRect.left) / zoom;
        const y2 = (bRect.top + bRect.height / 2 - canvasRect.top) / zoom;


        const points = [];
        points.push([x1, y1]);

        const verticalOffset = Math.abs(y2 - y1) / 2;

        if (x2 > x1 && ((x2 - x1) > 35)) {
            const midX = (x1 + x2) / 2;
            points.push([midX, y1]);
            points.push([midX, y2]);
        } else {
            const midX1 = x1 + 30;
            points.push([midX1, y1]);
            const midY = y1 < y2 ? y1 + verticalOffset : y1 - verticalOffset;
            const midX2 = x2 - 30;
            points.push([midX1, midY]);
            points.push([midX2, midY]);
            points.push([midX2, y2]);
        }

        points.push([x2, y2]);

        const d = points.map((p, i) => (i === 0 ? "M" : "L") + p[0] + "," + p[1]).join(" ");
        rel.path.setAttribute("d", d);
        if (rel.hitPath) rel.hitPath.setAttribute("d", d);
    }

    //********************************************************
    //                Кнопка добавить обьект                //
    //********************************************************
    document.getElementById("addBlock").onclick = () => {
        createBlock();
        saveState();
    };


    function updateAllConnections() {
        connections.forEach((el) => {
            let toId = el.to.dataset.blockId;
            let fromId = el.from.dataset.blockId;
            if (document.querySelector(`[data-block-id="${fromId}"]`) && document.querySelector(`[data-block-id="${toId}"]`)) {
                updateConnection(el);
            }else{
                el.path.remove();
                el.hitPath.remove();
            }
        });
    }

    function saveConnections() {
        saveState();
    }

    function saveState() {
        saveDraft();
    }

    //**************************************************************
    // Получить данные о текущем состоянии проекта в формате JSON //
    //**************************************************************
    function serializeState() {

        const blocks = Array.from(document.querySelectorAll(".block")).map(block => {
            const fields = Array.from(block.querySelectorAll(".fields li")).map(li => {
                const name = li.querySelector("span:nth-child(1)").innerText;
                const type = li.querySelector("span:nth-child(2)").innerText;
                return `${name} ${type}`;
            });

            const title = block.querySelector(".title")?.innerText || "Model";

            return {
                id: block.dataset.id,
                title,
                top: block.y,
                left: block.x,
                fields
            };
        });

        const rels = connections.map(c => ({
            fromId: c.from.closest(".block").dataset.id,
            fromField: c.from.dataset.fieldName,
            toId: c.to.closest(".block").dataset.id,
            toField: c.to.dataset.fieldName
        }));

        return {
            blocks,
            connections: rels
        };
    }

    //**************************************************************
    //         Загрузить конфигурацию проекта из data             //
    //**************************************************************
    function loadState(data) {

        // -------------  Очистить рабочее поле  --------------
        document.querySelectorAll(".block").forEach(b => b.remove());
        connections.forEach(c => c.path.remove());
        connections = [];

        // -------------  Восстановление блоков  --------------
        data.blocks.forEach(b => {
            createBlock({
                title: b.title,
                top: b.top,
                left: b.left,
                fields: b.fields
            });

            // -------  Задать блокам id и положение  --------
            const block = document.querySelectorAll(".block");
            const lastBlock = block[block.length - 1];
            lastBlock.dataset.id = b.id;
            lastBlock.x = b.left;
            lastBlock.y = b.top;
        });

        // ----------------- Восстановить связи  ---------------
        data.connections.forEach(rel => {

            const fromBlock = document.querySelector(`.block[data-id='${rel.fromId}']`);
            const toBlock = document.querySelector(`.block[data-id='${rel.toId}']`);

            if (!fromBlock || !toBlock) return;

            const fromField = Array.from(fromBlock.querySelectorAll("li"))
                .find(li => li.dataset.fieldName === rel.fromField);

            const toField = Array.from(toBlock.querySelectorAll("li"))
                .find(li => li.dataset.fieldName === rel.toField);

            // ------ Отрисовать линию -------
            if (fromField && toField) {
                connectFields(fromField, toField);
            }
        });
    }

    //***********************************************************************
    //  Сохранить в draft (черновик) после каждого действия с элементами   //
    //***********************************************************************
    function saveDraft() {
        const data = serializeState();
        localStorage.setItem("draftState", JSON.stringify(data));
        pushToHistory(data);
    }

    //************************************************************************
    //       Загрузить draft (черновик) - используется при запуске          //
    //************************************************************************
    function loadDraft() {
        const data = JSON.parse(localStorage.getItem("draftState") || "null");
        if (data) loadState(data);
    }


    //************************************************************
    //       Подстроить область рисования при перемещении       //
    //************************************************************
    function adjustCanvasSize() {
        const blocks = document.querySelectorAll(".block");
        let maxX = 0;
        let maxY = 0;

        blocks.forEach(block => {
            const right = block.x + block.offsetWidth;
            const bottom = block.y + block.offsetHeight;
            if (right > maxX) maxX = right;
            if (bottom > maxY) maxY = bottom;
        });

        // добавляем небольшой отступ
        const padding = 50;

        const newWidth = Math.max(canvas.offsetWidth, maxX + padding);
        const newHeight = Math.max(canvas.offsetHeight, maxY + padding);

        canvas.style.width = newWidth + "px";
        canvas.style.height = newHeight + "px";

        // также обновляем SVG
        const svg = document.getElementById("connections");
        svg.setAttribute('width', newWidth);
        svg.setAttribute('height', newHeight);
        svg.setAttribute('viewBox', `0 0 ${newWidth} ${newHeight}`);
    }


</script>

<script src="js/inspector.js"></script>
<script src="js/zoom.js"></script>
<script src="js/grid.js"></script>
<script src="js/main.js"></script>
<script src="js/undo-redo.js"></script>
<script src="js/project.js"></script>
</body>
</html>
