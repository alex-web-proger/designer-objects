<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–î–∏–∞–≥—Ä–∞–º–º–∞ —Å –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <style>
        body {
            margin: 0;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
        #toolbar {
            background: #dfdfdf;
            border-bottom: 1px solid #aaa;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #toolbar .group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #toolbar .separator {
            width: 1px;
            background: #aaa;
            height: 24px;
            margin: 0 8px;
        }

        #toolbar button {
            border: none;
            background: #fff;
            padding: 5px 8px;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        #toolbar button:hover {
            background: #eeeeee;
        }

        #toolbar button span {
            margin-left: 4px;
            font-size: 14px;
        }

        #toolbar button i {
            font-size: 18px;
            color: rgba(0, 0, 0, 0.7); /* –æ–±—â–∏–π —Å–≤–µ—Ç–ª—ã–π —Ç–æ–Ω */
            transition: color 0.2s;
        }

        #toolbar button:hover i {
            color: rgba(0, 0, 0, 1); /* –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ —Ç–µ–º–Ω–µ–µ */
        }

        /* –¶–≤–µ—Ç–∞ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
        #saveProject i {
            color: blue !important;
        }

        #loadProject i {
            color: orange !important;
        }

        #deleteProject i {
            color: tomato !important;
        }

        button.disabled i {
            color: rgba(0, 0, 0, 0.3) !important; /* –±–ª–µ–∫–ª—ã–π —Ü–≤–µ—Ç */
            cursor: default !important; /* –∫—É—Ä—Å–æ—Ä –Ω–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π */
            pointer-events: none !important; /* –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ—Ç –∫–ª–∏–∫–∏ */
        }

        /**/

        #main {
            flex: 1;
            display: flex;
            height: calc(100% - 40px);
        }

        #workspace {
            overflow: scroll;
            position: relative;
            background: #f0f0f0;
        }

        #workspace {
            width: 100%;
            height: calc(100vh - 42px);
            background: #f5f5f5;
            flex: 1;
            border-right: 1px solid #ccc;
            /*overflow: auto;*/
        }

        #inspector {
            width: 250px;
            background: #fafafa;
            border-left: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
        }

        #splitter {
            width: 3px;
            cursor: ew-resize;
            background: #ccc;
        }

        #canvas {
            position: relative;
            width: 2000px; /* —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ */
            height: 2000px; /* —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ */
        }

        /*.block {*/
        /*    position: absolute;*/
        /*    width: 120px;*/
        /*    height: 60px;*/
        /*    background-color: #3f51b5;*/
        /*    color: white;*/
        /*    border-radius: 6px;*/
        /*    text-align: center;*/
        /*    line-height: 60px;*/
        /*    user-select: none;*/
        /*    cursor: grab;*/
        /*    font-weight: bold;*/
        /*}*/

        .block {
            position: absolute;
            width: 240px;
            background: white;
            border: 1px solid #999;
            border-radius: 2px;
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1);
        }

        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #e6e6e6;
            padding: 6px 10px;
            font-weight: bold;
            cursor: move;
        }

        .block-header .title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            display: inline-block;
            vertical-align: middle;
        }

        .title-input {
            flex: 1;
            margin-right: 6px;
            font-weight: bold;
            border: 1px solid #fff;
            padding: 1px 2px;
            font-size: 14px;
        }

        .delete-block {
            cursor: pointer;
            color: red;
        }

        .fields {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .fields li {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .fields li:hover {
            background: #f9f9f9;
        }

        .add-field {
            display: block;
            width: 100%;
            padding: 5px;
            border: none;
            background: #e0e0e0;
            cursor: pointer;
        }


        /*svg {*/
        /*    position: absolute;*/
        /*    top: 0;*/
        /*    left: 0;*/
        /*    pointer-events: none;*/
        /*    z-index: 0;*/
        /*}*/

        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }


        #workspace, .block, .header, .title {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>
<body>

<!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
<div id="toolbar">

    <!-- –†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ–µ–∫—Ç–æ–º -->
    <div class="group">
        <button title="–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç" id="newProject"><i class="far fa-file"></i></button>
        <button title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç" id="saveProject"><i class="fas fa-floppy-disk"></i></button>
        <button title="–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–µ–∫—Ç" id="loadProject"><i class="fas fa-folder-open"></i></button>
        <button title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç" id="deleteProject"><i class="fas fa-trash"></i></button>
    </div>

    <div class="separator"></div>

    <!-- Undo/Redo –∏ –º–∞—Å—à—Ç–∞–± -->
    <div class="group">
        <button title="Undo" id="undo" class="disabled"><i class="fas fa-undo"></i></button>
        <button title="Redo" id="redo" class="disabled"><i class="fas fa-redo"></i></button>
        <button title="–£–≤–µ–ª–∏—á–∏—Ç—å –º–∞—Å—à—Ç–∞–±" id="zoomIn"><i class="fas fa-magnifying-glass-plus"></i></button>
        <button title="–£–º–µ–Ω—å—à–∏—Ç—å –º–∞—Å—à—Ç–∞–±" id="zoomOut"><i class="fas fa-magnifying-glass-minus"></i></button>
        <button title="–°–±—Ä–æ—Å –º–∞—Å—à—Ç–∞–±–∞" id="zoomReset"><i class="fas fa-magnifying-glass"></i></button>
    </div>

    <div class="separator"></div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="group">
        <button title="–î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É" id="addBlock"><i class="fas fa-plus"></i></button>
        <button title="–î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å" id="addConnection"><i class="fas fa-link"></i></button>
    </div>
</div>

<div id="main">
    <div id="workspace">
        <div id="canvas">
            <svg id="connections">
                <defs>
                    <!-- –≤–æ—Ä–æ–Ω—å—è –ª–∞–ø–∫–∞ (N) -->
                    <marker id="many" class="marker-relation" markerWidth="14" markerHeight="14" refX="13" refY="7"
                            orient="auto" markerUnits="strokeWidth">
                        <path d="M13,0 L1,7 L13,14" stroke="gray" stroke-width="1" fill="none"/>
                    </marker>

                    <marker id="many-start" class="marker-relation" markerWidth="14" markerHeight="14" refX="0" refY="7"
                            orient="auto" markerUnits="strokeWidth">
                        <path d="M0,0 L13,7 L0,13" stroke="gray" stroke-width="1" fill="none"/>
                    </marker>
                </defs>
            </svg>
        </div>
    </div>

    <div id="splitter"></div>

    <div id="inspector">
        <h3>–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç‚Ä¶</p>
        <p>X1: <span id="x1"></span></p>
        <p>Y1: <span id="y1"></span></p>
        <p>X2: <span id="x2"></span></p>
        <p>Y2: <span id="y2"></span></p>
        <p>X3: <span id="x3"></span></p>
        <p>Y3: <span id="y3"></span></p>
    </div>
</div>

<script>
    const svgContainer = document.getElementById("connections");
    const canvas = document.getElementById('canvas');
    let connecting = null;
    let tempLine = null;
    let connections = [];

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentProjectId = null;

    // === –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è Undo/Redo ===
    let history = [];
    let historyPointer = -1;

    // ------------------- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–º–µ–Ω -------------------
    function toModelName(name) {
        name = name.replace(/[^a-zA-Z0-9\s_]/g, "").trim();
        const parts = name.split(/[\s_]+/);
        const camel = parts.map(p => p.charAt(0).toUpperCase() + p.slice(1).toLowerCase()).join("");
        return camel || "Model";
    }

    function isUniqueName(name, currentBlock = null) {
        const allTitles = Array.from(document.querySelectorAll(".block .title"))
            .filter(t => t !== currentBlock)
            .map(t => t.innerText.trim());
        return !allTitles.includes(name.trim());
    }

    function getUniqueDefaultName(base = "Model") {
        base = toModelName(base);
        let name = base, suffix = 1;
        while (!isUniqueName(name)) {
            name = base + '_' + suffix++;
        }
        return name;
    }

    // ------------------- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ -------------------
    function enableEditing(titleEl) {
        const currentText = titleEl.innerText;
        const input = document.createElement("input");
        input.type = "text";
        input.value = currentText;
        input.className = "title-input";
        titleEl.replaceWith(input);
        input.focus();
        input.addEventListener("blur", () => finishEditing(input));
        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") finishEditing(input);
        });
    }

    function finishEditing(input) {
        let newName = toModelName(input.value);
        let suffix = 1, baseName = newName;
        while (!isUniqueName(newName, input)) {
            newName = `${baseName}${suffix++}`;
        }
        const newTitle = document.createElement("div");
        newTitle.className = "title";
        newTitle.innerText = newName;
        input.replaceWith(newTitle);
        let header = newTitle.parentElement;
        header.ondblclick = () => enableEditing(newTitle);
        saveState();
    }

    // –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ UUID
    function generateUUID() {
        // –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç UUID v4
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    //*******************************************************
    //                     –°–æ–∑–¥–∞–Ω–∏–µ –±–ª–æ–∫–∞                  //
    //*******************************************************
    function createBlock(data = null) {

        const block = document.createElement("div");

        block.className = "block";
        block.style.top = (data?.top || 50) + "px";
        block.style.left = (data?.left || 50) + "px";
        // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π UUID
        block.dataset.id = data?.id || generateUUID();

        const uniqueName = getUniqueDefaultName("Model");

        block.innerHTML = `
      <div class="block-header">
        <span class="title">${data?.title || uniqueName}</span>
        <span class="delete-block">√ó</span>
      </div>
      <ul class="fields">
        ${(data?.fields || ["id INT", "name VARCHAR"]).map(f => {
            const [name, type] = f.split(" ");
            return `<li data-field-name="${name}" data-block-id="${block.dataset.id}"><span>${name}</span><span>${type}</span></li>`;
        }).join("")}
      </ul>
      <button class="add-field">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
    `;

        workspace.appendChild(block);

        block.x = block.offsetLeft;
        block.y = block.offsetTop;

        let title = block.querySelector(".title");

        title.title = "–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–º–µ–Ω–∏ - –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫";

        block.querySelector(".delete-block").onclick = () => {
            if (confirm("–£–¥–∞–ª–∏—Ç—å –æ–±—å–µ–∫—Ç?")) {
                block.remove();
                saveState();
            }
        };

        // block.querySelector(".add-field").onclick = () => {
        //     const li = document.createElement("li");
        //     li.innerHTML = "<span>new_field</span><span>INT</span>";
        //     block.querySelector(".fields").appendChild(li);
        //     attachFieldEvents(li);
        //     saveState();
        // };
        //
        title.parentElement.ondblclick = () => enableEditing(title);

        // ------------------- –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ -------------------
        let header = block.querySelector(".block-header");

        header.onmousedown = e => {
            if (e.shiftKey) {
                //startFieldConnection(block, e);
            } else {
                startDragging(block, e);
            }
        };

        [...block.querySelectorAll("li")].forEach(attachFieldEvents);

        adjustCanvasSize();

        //saveState();
    }

    //*******************************************************
    //                   –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ                    //
    //*******************************************************
    function startDragging(block, e) {

        let startX = e.clientX;
        let startY = e.clientY;

        // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –±–ª–æ–∫–∞
        function onMouseMove(ev) {

            const dx = ev.clientX - startX;
            const dy = ev.clientY - startY;

            block.x += dx;
            block.y += dy;

            block.x = block.x < 10 ? 10 : block.x;
            block.y = block.y < 10 ? 10 : block.y;

            //document.getElementById('x1').innerHTML = block.y;

            block.style.left = block.x + "px";
            block.style.top = block.y + "px";

            startX = ev.clientX;
            startY = ev.clientY;

            adjustCanvasSize();
            updateAllConnections();
        }

        document.addEventListener("mousemove", onMouseMove);

        document.onmouseup = () => {
            document.removeEventListener("mousemove", onMouseMove);
            document.onmouseup = null;
            saveState();
        };
    }

    //********************************************************
    //             –°–æ–±—ã—Ç–∏—è –ø–æ–ª–µ–π –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è             //
    //********************************************************
    function attachFieldEvents(li) {

        li.onmousedown = e => {

            if (e.shiftKey) {

                startFieldConnection(li, e);

                e.preventDefault();
            }
        };
    }

    // ------------ –ù–∞—á–∞–ª–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ–ª—è ------------------
    function startFieldConnection(li, e) {
        connecting = li;
        tempLine = document.createElementNS("http://www.w3.org/2000/svg", "path");
        tempLine.setAttribute("stroke", "gray");
        tempLine.setAttribute("stroke-width", "1");
        tempLine.setAttribute("fill", "none");
        tempLine.setAttribute("stroke-dasharray", "5,5");
        svgContainer.appendChild(tempLine);
        document.addEventListener("mousemove", onTempLineMoveField); // —Ä–∏—Å—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ª–∏–Ω–∏—é
        document.addEventListener("mouseup", onTempLineEndField);    // –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—É—â–µ–Ω–∞ - —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    }

    // ------------------- –í—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è -------------------
    function onTempLineMoveField(e) {
        if (!connecting) return;
        const a = connecting.getBoundingClientRect();
        const cs = canvas.getBoundingClientRect();
        const x1 = a.right - cs.left;
        const y1 = a.top + a.height / 2 - cs.top;
        const x2 = e.clientX - cs.left;
        const y2 = e.clientY - cs.top;
        const midX = (x1 + x2) / 2;
        tempLine.setAttribute("d", `M${x1},${y1} L${midX},${y1} L${midX},${y2} L${x2},${y2}`);
    }

    // ------------------- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è -------------------
    function onTempLineEndField(e) {
        if (!connecting) return;
        const target = document.elementFromPoint(e.clientX, e.clientY);
        const targetLi = target.closest("li");
        if (targetLi && targetLi !== connecting) {
            connectFields(connecting, targetLi);
            saveConnections();
        }
        tempLine.remove();
        tempLine = null;
        connecting = null;
        document.removeEventListener("mousemove", onTempLineMoveField);
        document.removeEventListener("mouseup", onTempLineEndField);
    }

    // ------------------- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –ª–∏–Ω–∏–∏ -------------------
    function connectFields(fromLi, toLi, type = "one-to-many") {
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("stroke", "gray");
        path.setAttribute("stroke-width", "1");
        path.setAttribute("fill", "none");
        path.setAttribute("marker-start", "url(#many-start)");
        path.setAttribute("marker-end", "url(#many)");
        svgContainer.appendChild(path);

        // —Ö–∏—Ç-–∑–æ–Ω–∞ ‚Äî –Ω–µ–≤–∏–¥–∏–º–∞—è –ª–∏–Ω–∏—è –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –Ω–∞–≤–µ–¥–µ–Ω–∏—è
        const hitPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        hitPath.setAttribute("stroke", "transparent");
        hitPath.setAttribute("stroke-width", "8"); // —É–¥–æ–±–Ω–∞—è –∑–æ–Ω–∞
        hitPath.setAttribute("fill", "none");
        hitPath.setAttribute("pointer-events", "stroke"); // —á—Ç–æ–±—ã –ª–æ–≤–∏–ª–∞ —Å–æ–±—ã—Ç–∏—è
        svgContainer.appendChild(hitPath);

        // —É–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏ –ø–æ –∫–ª–∏–∫—É
        path.addEventListener("click", () => {
            if (confirm("–£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å?")) {
                const idx = connections.findIndex(c => c.path === path);
                if (idx !== -1) {
                    connections[idx].path.remove();         // —É–±—Ä–∞—Ç—å –∏–∑ DOM
                    connections.splice(idx, 1);  // —É–±—Ä–∞—Ç—å –∏–∑ –º–∞—Å—Å–∏–≤–∞
                    saveConnections();                      // –æ–±–Ω–æ–≤–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                }
            }
        });

        hitPath.addEventListener("mouseenter", () => {
            path.setAttribute("stroke", "#666");
            path.setAttribute("stroke-width", "2")
        });
        hitPath.addEventListener("mouseleave", () => {
            path.setAttribute("stroke", "gray");
            path.setAttribute("stroke-width", "1")
        });

        const rel = {from: fromLi, to: toLi, path, hitPath};
        connections.push(rel);

        updateConnection(rel);
    }

    // ------------------- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–∏ -------------------
    function updateConnection(rel) {
        const from = rel.from;
        const to = rel.to;
        const svg = document.getElementById('connections');
        const canvas = document.getElementById('canvas');

        // –ü–æ–¥–≥–æ–Ω—è–µ–º SVG –ø–æ–¥ canvas
        const width = canvas.offsetWidth;
        const height = canvas.offsetHeight;
        svg.setAttribute('width', width);
        svg.setAttribute('height', height);
        svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã li —á–µ—Ä–µ–∑ getBoundingClientRect
        const aRect = from.getBoundingClientRect();
        const bRect = to.getBoundingClientRect();
        const canvasRect = canvas.getBoundingClientRect();

        const x1 = aRect.right - canvasRect.left;
        const y1 = aRect.top + aRect.height / 2 - canvasRect.top;
        const x2 = bRect.left - canvasRect.left;
        const y2 = bRect.top + bRect.height / 2 - canvasRect.top;

        const points = [];
        points.push([x1, y1]);

        const verticalOffset = Math.abs(y2 - y1) / 2;

        if (x2 > x1 && ((x2 - x1) > 35)) {
            const midX = (x1 + x2) / 2;
            points.push([midX, y1]);
            points.push([midX, y2]);
        } else {
            const midX1 = x1 + 30;
            points.push([midX1, y1]);
            const midY = y1 < y2 ? y1 + verticalOffset : y1 - verticalOffset;
            const midX2 = x2 - 30;
            points.push([midX1, midY]);
            points.push([midX2, midY]);
            points.push([midX2, y2]);
        }

        points.push([x2, y2]);

        const d = points.map((p, i) => (i === 0 ? "M" : "L") + p[0] + "," + p[1]).join(" ");
        rel.path.setAttribute("d", d);
        if (rel.hitPath) rel.hitPath.setAttribute("d", d);
    }

    //********************************************************
    //                –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—å–µ–∫—Ç                //
    //********************************************************
    document.getElementById("addBlock").onclick = () => {
        createBlock();
        saveState();
    };


    function updateAllConnections() {
        connections.forEach(updateConnection);
    }

    function saveConnections() {
        saveState();
    }

    function saveState() {
        saveDraft();
    }

    //**************************************************************
    // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON //
    //**************************************************************
    function serializeState() {

        const blocks = Array.from(document.querySelectorAll(".block")).map(block => {
            const fields = Array.from(block.querySelectorAll(".fields li")).map(li => {
                const name = li.querySelector("span:nth-child(1)").innerText;
                const type = li.querySelector("span:nth-child(2)").innerText;
                return `${name} ${type}`;
            });

            const title = block.querySelector(".title")?.innerText || "Model";

            return {
                id: block.dataset.id,
                title,
                top: block.y,
                left: block.x,
                fields
            };
        });

        const rels = connections.map(c => ({
            fromId: c.from.closest(".block").dataset.id,
            fromField: c.from.dataset.fieldName,
            toId: c.to.closest(".block").dataset.id,
            toField: c.to.dataset.fieldName
        }));

        return {
            blocks,
            connections: rels
        };
    }

    //**************************************************************
    //         –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ data             //
    //**************************************************************
    function loadState(data) {

        // -------------  –û—á–∏—Å—Ç–∏—Ç—å —Ä–∞–±–æ—á–µ–µ –ø–æ–ª–µ  --------------
        document.querySelectorAll(".block").forEach(b => b.remove());
        connections.forEach(c => c.path.remove());
        connections = [];

        // -------------  –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤  --------------
        data.blocks.forEach(b => {
            createBlock({
                title: b.title,
                top: b.top,
                left: b.left,
                fields: b.fields
            });

            // -------  –ó–∞–¥–∞—Ç—å –±–ª–æ–∫–∞–º id –∏ –ø–æ–ª–æ–∂–µ–Ω–∏–µ  --------
            const block = document.querySelectorAll(".block");
            const lastBlock = block[block.length - 1];
            lastBlock.dataset.id = b.id;
            lastBlock.x = b.left;
            lastBlock.y = b.top;
        });

        // ----------------- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑–∏  ---------------
        data.connections.forEach(rel => {

            const fromBlock = document.querySelector(`.block[data-id='${rel.fromId}']`);
            const toBlock = document.querySelector(`.block[data-id='${rel.toId}']`);

            if (!fromBlock || !toBlock) return;

            const fromField = Array.from(fromBlock.querySelectorAll("li"))
                .find(li => li.dataset.fieldName === rel.fromField);

            const toField = Array.from(toBlock.querySelectorAll("li"))
                .find(li => li.dataset.fieldName === rel.toField);

            // ------ –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –ª–∏–Ω–∏—é -------
            if (fromField && toField) {
                connectFields(fromField, toField);
            }
        });
    }
    //***********************************************************************
    //  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ draft (—á–µ—Ä–Ω–æ–≤–∏–∫) –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏   //
    //***********************************************************************
    function saveDraft() {
        const data = serializeState();
        localStorage.setItem("draftState", JSON.stringify(data));
        pushToHistory(data);
    }
    //************************************************************************
    //       –ó–∞–≥—Ä—É–∑–∏—Ç—å draft (—á–µ—Ä–Ω–æ–≤–∏–∫) - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ          //
    //************************************************************************
    function loadDraft() {
        const data = JSON.parse(localStorage.getItem("draftState") || "null");
        if (data) loadState(data);
    }
    //***************************************************************
    //        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–±–æ—á–µ–µ –ø–æ–ª–µ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç          //
    //***************************************************************
    function saveCurrentProjectAs(name) {
        const id = crypto.randomUUID(); // üìå UUID
        const saved = JSON.parse(localStorage.getItem("savedProjects") || "{}");
        saved[id] = {
            id,
            name,
            timestamp: Date.now(),
            data: serializeState()
        };
        localStorage.setItem("savedProjects", JSON.stringify(saved));
        alert("–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!");
    }
    //***************************************************************
    //   –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Ä–∞–±–æ—á–µ–µ –ø–æ–ª–µ –ø—Ä–æ–µ–∫—Ç –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–æ –µ–≥–æ ID   //
    //***************************************************************
    function loadProject(id) {
        const saved = JSON.parse(localStorage.getItem("savedProjects") || "{}");
        if (saved[id]) {
            loadState(saved[id].data);
            currentProjectId = id;
        }
    }
    //***************************************************************
    //           –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–æ –µ–≥–æ ID             //
    //***************************************************************
    function deleteProject(id) {
        const saved = JSON.parse(localStorage.getItem("savedProjects") || "{}");
        delete saved[id];
        localStorage.setItem("savedProjects", JSON.stringify(saved));
    }

    //*************************************************************
    //                   –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è –ø—Ä–æ–µ–∫—Ç–∞                   //
    //*************************************************************
    document.getElementById("saveProject").onclick = () => {
        const name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø—Ä–æ–µ–∫—Ç–∞:");
        if (name) saveCurrentProjectAs(name);
    };

    //**************************************************************
    //               –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞                   //
    //**************************************************************
    document.getElementById("loadProject").onclick = () => {
        const saved = JSON.parse(localStorage.getItem("savedProjects") || "{}");
        const keys = Object.keys(saved);
        if (keys.length === 0) {
            alert("–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤");
            return;
        }
        const menu = keys.map((k, i) => `${i + 1}. ${saved[k].name}`).join("\n");
        const choice = prompt(`–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞:\n${menu}`);
        const index = parseInt(choice);
        if (!isNaN(index) && index > 0 && index <= keys.length) {
            loadProject(keys[index - 1]);
        }
    };

    //*************************************************************
    //                –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞                   //
    //*************************************************************
    document.getElementById("deleteProject").onclick = () => {
        const saved = JSON.parse(localStorage.getItem("savedProjects") || "{}");
        const keys = Object.keys(saved);
        if (keys.length === 0) {
            alert("–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è");
            return;
        }
        const menu = keys.map((k, i) => `${i + 1}. ${saved[k].name}`).join("\n");
        const choice = prompt(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç:\n${menu}`);
        const index = parseInt(choice);
        if (!isNaN(index) && index > 0 && index <= keys.length) {
            if (confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å?")) {
                deleteProject(keys[index - 1]);
                alert("–ü—Ä–æ–µ–∫—Ç —É–¥–∞–ª—ë–Ω");
            }
        }
    };

    //************************************************************
    //       –ü–æ–¥—Å—Ç—Ä–æ–∏—Ç—å –æ–±–ª–∞—Å—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏       //
    //************************************************************
    function adjustCanvasSize() {
        const blocks = document.querySelectorAll(".block");
        let maxX = 0;
        let maxY = 0;

        blocks.forEach(block => {
            const right = block.x + block.offsetWidth;
            const bottom = block.y + block.offsetHeight;
            if (right > maxX) maxX = right;
            if (bottom > maxY) maxY = bottom;
        });

        // –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø
        const padding = 50;

        const newWidth = Math.max(canvas.offsetWidth, maxX + padding);
        const newHeight = Math.max(canvas.offsetHeight, maxY + padding);

        canvas.style.width = newWidth + "px";
        canvas.style.height = newHeight + "px";

        // —Ç–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º SVG
        const svg = document.getElementById("connections");
        svg.setAttribute('width', newWidth);
        svg.setAttribute('height', newHeight);
        svg.setAttribute('viewBox', `0 0 ${newWidth} ${newHeight}`);
    }

    //**************************************************************
    //                –ó–∞–ø–æ–º–Ω–∏—Ç—å –æ—á–µ—Ä–µ–¥–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ               //
    //**************************************************************
    function pushToHistory(state) {

        // –£–¥–∞–ª—è–µ–º –≤—Å—ë "–≤–ø–µ—Ä—ë–¥", –µ—Å–ª–∏ –º—ã –æ—Ç–∫–∞—Ç–∏–ª–∏—Å—å –Ω–∞–∑–∞–¥
        if (historyPointer < history.length - 1) {
            history = history.slice(0, historyPointer + 1);
        }

        // –ø–æ–º–µ—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –º–∞—Å—Å–∏–≤ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        historyPointer++;
        history.push(JSON.stringify(state));
        updateUndoRedoButtons();
    }

    //*************************************************************
    //                –ü—Ä–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π                  //
    //*************************************************************
    function canUndo() {
        return historyPointer > 0;
    }
    function canRedo() {
        return historyPointer < history.length - 1;
    }

    function undo() {
        if (!canUndo()) return;
        historyPointer--;
        document.getElementById('x1').innerHTML = historyPointer;
        loadState(JSON.parse(history[historyPointer]));
        updateUndoRedoButtons();
    }

    function redo() {
        if (!canRedo()) return;
        historyPointer++;
        loadState(JSON.parse(history[historyPointer]));
        updateUndoRedoButtons();
    }

    function updateUndoRedoButtons() {
        const undoBtn = document.getElementById('undo');
        const redoBtn = document.getElementById('redo');

        if (canUndo()) {
            undoBtn.classList.remove("disabled");
        } else {
            undoBtn.classList.add("disabled");
        }

        if (canRedo()) {
            redoBtn.classList.remove("disabled");
        } else {
            redoBtn.classList.add("disabled");
        }
    }

    function initHistoryWithState(state) {
        history = [JSON.stringify(state)];
        historyPointer = 0;
        updateUndoRedoButtons();
    }
    // ---------------------  –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π  -------------------
    document.getElementById('undo').onclick = undo;
    document.getElementById('redo').onclick = redo;

    let zoomLevel = 1;
    const zoomStep = 0.1;

    function applyZoom() {
        canvas.style.transform = `scale(${zoomLevel})`;
        canvas.style.transformOrigin = '0 0';
    }

    document.getElementById('zoomIn').onclick = () => {
        zoomLevel += zoomStep;
        applyZoom();
    };

    document.getElementById('zoomOut').onclick = () => {
        zoomLevel = Math.max(zoomStep, zoomLevel - zoomStep);
        applyZoom();
    };

    document.getElementById('zoomReset').onclick = () => {
        zoomLevel = 1;
        applyZoom();
    };


    // ----------- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ -----------
    loadDraft();

    //  ----------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–µ–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏  ----------------------
    initHistoryWithState(serializeState());

</script>

</body>
</html>
