<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–î–∏–∞–≥—Ä–∞–º–º–∞ —Å –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <style>
        body {
            margin: 0;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
        #toolbar {
            background: #dfdfdf;
            border-bottom: 1px solid #aaa;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #toolbar .group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #toolbar .separator {
            width: 1px;
            background: #aaa;
            height: 24px;
            margin: 0 8px;
        }

        #toolbar button {
            border: none;
            background: #fff;
            padding: 5px 8px;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        #toolbar button:hover {
            background: #eeeeee;
        }

        #toolbar button span {
            margin-left: 4px;
            font-size: 14px;
        }

        #toolbar button i {
            font-size: 18px;
            color: rgba(0, 0, 0, 0.7); /* –æ–±—â–∏–π —Å–≤–µ—Ç–ª—ã–π —Ç–æ–Ω */
            transition: color 0.2s;
        }

        #toolbar button:hover i {
            color: rgba(0, 0, 0, 1); /* –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ —Ç–µ–º–Ω–µ–µ */
        }

        /* –¶–≤–µ—Ç–∞ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
        #saveProject i {
            color: blue !important;
        }

        #loadProject i {
            color: orange !important;
        }

        #deleteProject i {
            color: tomato !important;
        }

        button.disabled i {
            color: rgba(0, 0, 0, 0.3) !important; /* –±–ª–µ–∫–ª—ã–π —Ü–≤–µ—Ç */
            cursor: default !important; /* –∫—É—Ä—Å–æ—Ä –Ω–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π */
            pointer-events: none !important; /* –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ—Ç –∫–ª–∏–∫–∏ */
        }

        /**/

        #main {
            flex: 1;
            display: flex;
            height: calc(100% - 40px);
        }

        #workspace {
            overflow: scroll;
            position: relative;
            background: #f0f0f0;
        }

        #workspace {
            width: 100%;
            height: calc(100vh - 42px);
            background: #f5f5f5;
            flex: 1;
            border-right: 1px solid #ccc;
            /*overflow: auto;*/
        }

        #inspector {
            width: 250px;
            background: #fafafa;
            border-left: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
        }

        #splitter {
            width: 3px;
            cursor: ew-resize;
            background: #ccc;
        }

        #canvas {
            position: relative;
            width: 2000px; /* —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ */
            height: 2000px; /* —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ */
        }

        /*.block {*/
        /*    position: absolute;*/
        /*    width: 120px;*/
        /*    height: 60px;*/
        /*    background-color: #3f51b5;*/
        /*    color: white;*/
        /*    border-radius: 6px;*/
        /*    text-align: center;*/
        /*    line-height: 60px;*/
        /*    user-select: none;*/
        /*    cursor: grab;*/
        /*    font-weight: bold;*/
        /*}*/

        .block {
            position: absolute;
            width: 240px;
            background: white;
            border: 1px solid #999;
            border-radius: 2px;
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1);
        }

        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #e6e6e6;
            padding: 6px 10px;
            font-weight: bold;
            cursor: move;
        }

        .block-header .title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            display: inline-block;
            vertical-align: middle;
        }

        .title-input {
            flex: 1;
            margin-right: 6px;
            font-weight: bold;
            border: 1px solid #fff;
            padding: 1px 2px;
            font-size: 14px;
        }

        .delete-block {
            cursor: pointer;
            color: red;
        }

        .fields {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .fields li {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .fields li:hover {
            background: #f9f9f9;
        }

        .add-field {
            display: block;
            width: 100%;
            padding: 5px;
            border: none;
            background: #e0e0e0;
            cursor: pointer;
        }


        /*svg {*/
        /*    position: absolute;*/
        /*    top: 0;*/
        /*    left: 0;*/
        /*    pointer-events: none;*/
        /*    z-index: 0;*/
        /*}*/

        svg{
            position: absolute;
            top:0;
            left:0;
            width:100%;
            height:100%;
            pointer-events:none;
        }
 

        #workspace, .block, .header, .title {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>
<body>

<!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
<div id="toolbar">

    <!-- –†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ–µ–∫—Ç–æ–º -->
    <div class="group">
        <button title="–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç" id="newProject"><i class="far fa-file"></i></button>
        <button title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç" id="saveProject"><i class="fas fa-floppy-disk"></i></button>
        <button title="–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–µ–∫—Ç" id="loadProject"><i class="fas fa-folder-open"></i></button>
        <button title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç" id="deleteProject"><i class="fas fa-trash"></i></button>
    </div>

    <div class="separator"></div>

    <!-- Undo/Redo –∏ –º–∞—Å—à—Ç–∞–± -->
    <div class="group">
        <button title="Undo" id="undo" class="disabled"><i class="fas fa-undo"></i></button>
        <button title="Redo" id="redo"><i class="fas fa-redo"></i></button>
        <button title="–£–≤–µ–ª–∏—á–∏—Ç—å –º–∞—Å—à—Ç–∞–±" id="zoomIn"><i class="fas fa-magnifying-glass-plus"></i></button>
        <button title="–£–º–µ–Ω—å—à–∏—Ç—å –º–∞—Å—à—Ç–∞–±" id="zoomOut"><i class="fas fa-magnifying-glass-minus"></i></button>
        <button title="–°–±—Ä–æ—Å –º–∞—Å—à—Ç–∞–±–∞" id="zoomReset"><i class="fas fa-magnifying-glass"></i></button>
    </div>

    <div class="separator"></div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="group">
        <button title="–î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É" id="addBlock"><i class="fas fa-plus"></i></button>
        <button title="–î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å" id="addConnection"><i class="fas fa-link"></i></button>
    </div>
</div>

<div id="main">
    <div id="workspace">
        <div id="canvas">
            <svg id="connections">
                <defs>
                    <!-- –≤–æ—Ä–æ–Ω—å—è –ª–∞–ø–∫–∞ (N) -->
                    <marker id="many" class="marker-relation" markerWidth="14" markerHeight="14" refX="13" refY="7"
                            orient="auto" markerUnits="strokeWidth">
                        <path d="M13,0 L1,7 L13,14" stroke="gray" stroke-width="1" fill="none"/>
                    </marker>

                    <marker id="many-start" class="marker-relation" markerWidth="14" markerHeight="14" refX="0" refY="7"
                            orient="auto" markerUnits="strokeWidth">
                        <path d="M0,0 L13,7 L0,13" stroke="gray" stroke-width="1" fill="none"/>
                    </marker>
                </defs>
            </svg>
        </div>
    </div>

    <div id="splitter"></div>

    <div id="inspector">
        <h3>–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç‚Ä¶</p>
        <p>X1: <span id="x1"></span></p>
        <p>Y1: <span id="y1"></span></p>
        <p>X2: <span id="x2"></span></p>
        <p>Y2: <span id="y2"></span></p>
        <p>X3: <span id="x3"></span></p>
        <p>Y3: <span id="y3"></span></p>
    </div>
</div>

<script>
    const svgContainer = document.getElementById("connections");
    const canvas = document.getElementById('canvas');
    let connecting = null;
    let tempLine = null;
    let connections = [];

    // ------------------- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–º–µ–Ω -------------------
    function toModelName(name) {
        name = name.replace(/[^a-zA-Z0-9\s_]/g, "").trim();
        const parts = name.split(/[\s_]+/);
        const camel = parts.map(p => p.charAt(0).toUpperCase() + p.slice(1).toLowerCase()).join("");
        return camel || "Model";
    }

    function isUniqueName(name, currentBlock = null) {
        const allTitles = Array.from(document.querySelectorAll(".block .title"))
            .filter(t => t !== currentBlock)
            .map(t => t.innerText.trim());
        return !allTitles.includes(name.trim());
    }

    function getUniqueDefaultName(base = "Model") {
        base = toModelName(base);
        let name = base, suffix = 1;
        while (!isUniqueName(name)) {
            name = base + '_' + suffix++;
        }
        return name;
    }

    // ------------------- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ -------------------
    function enableEditing(titleEl) {
        const currentText = titleEl.innerText;
        const input = document.createElement("input");
        input.type = "text";
        input.value = currentText;
        input.className = "title-input";
        titleEl.replaceWith(input);
        input.focus();
        input.addEventListener("blur", () => finishEditing(input));
        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") finishEditing(input);
        });
    }

    function finishEditing(input) {
        let newName = toModelName(input.value);
        let suffix = 1, baseName = newName;
        while (!isUniqueName(newName, input)) {
            newName = `${baseName}${suffix++}`;
        }
        const newTitle = document.createElement("div");
        newTitle.className = "title";
        newTitle.innerText = newName;
        input.replaceWith(newTitle);
        let header = newTitle.parentElement;
        header.ondblclick = () => enableEditing(newTitle);
        saveState();
    }

    //*******************************************************
    //                     –°–æ–∑–¥–∞–Ω–∏–µ –±–ª–æ–∫–∞                  //
    //*******************************************************
    function createBlock(data = null) {

        const block = document.createElement("div");

        block.className = "block";
        block.style.top = (data?.top || 50) + "px";
        block.style.left = (data?.left || 50) + "px";

        const uniqueName = getUniqueDefaultName("Model");

        block.innerHTML = `
      <div class="block-header">
        <span class="title">${data?.title || uniqueName}</span>
        <span class="delete-block">√ó</span>
      </div>
      <ul class="fields">
        ${(data?.fields || ["id INT", "name VARCHAR"]).map(f => {
            const [name, type] = f.split(" ");
            return `<li data-field-name="${name}"><span>${name}</span><span>${type}</span></li>`;
        }).join("")}
      </ul>
      <button class="add-field">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
    `;

        workspace.appendChild(block);

        block.x = block.offsetLeft;
        block.y = block.offsetTop;

        let title = block.querySelector(".title");

        title.title = "–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–º–µ–Ω–∏ - –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫";

        block.querySelector(".delete-block").onclick = () => {
            if (confirm("–£–¥–∞–ª–∏—Ç—å –æ–±—å–µ–∫—Ç?")) {
                block.remove();
                saveState();
            }
        };

        // block.querySelector(".add-field").onclick = () => {
        //     const li = document.createElement("li");
        //     li.innerHTML = "<span>new_field</span><span>INT</span>";
        //     block.querySelector(".fields").appendChild(li);
        //     attachFieldEvents(li);
        //     saveState();
        // };
        //
        title.parentElement.ondblclick = () => enableEditing(title);

        // ------------------- –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ -------------------
        let header = block.querySelector(".block-header");

        header.onmousedown = e => {
            if (e.shiftKey) {
                //startFieldConnection(block, e);
            } else {
                startDragging(block, e);
            }
        };

        [...block.querySelectorAll("li")].forEach(attachFieldEvents);

        saveState();
    }

    //*******************************************************
    //                   –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ                    //
    //*******************************************************
    function startDragging(block, e) {

        let startX = e.clientX;
        let startY = e.clientY;

        // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –±–ª–æ–∫–∞
        function onMouseMove(ev) {

            const dx = ev.clientX - startX;
            const dy = ev.clientY - startY;

            block.x += dx;
            block.y += dy;

            block.x = block.x < 10 ? 10 : block.x;
            block.y = block.y < 10 ? 10 : block.y;

            //document.getElementById('x1').innerHTML = block.y;

            block.style.left = block.x + "px";
            block.style.top = block.y + "px";

            startX = ev.clientX;
            startY = ev.clientY;

            updateAllConnections();
        }

        document.addEventListener("mousemove", onMouseMove);

        document.onmouseup = () => {
            document.removeEventListener("mousemove", onMouseMove);
            document.onmouseup = null;
            saveState();
        };
    }

    //********************************************************
    //             –°–æ–±—ã—Ç–∏—è –ø–æ–ª–µ–π –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è             //
    //********************************************************
    function attachFieldEvents(li) {

        li.onmousedown = e => {

            if (e.shiftKey) {

                startFieldConnection(li, e);

                e.preventDefault();
            }
        };
    }

    // ------------ –ù–∞—á–∞–ª–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ–ª—è ------------------
    function startFieldConnection(li, e) {
        connecting = li;
        tempLine = document.createElementNS("http://www.w3.org/2000/svg", "path");
        tempLine.setAttribute("stroke", "gray");
        tempLine.setAttribute("stroke-width", "1");
        tempLine.setAttribute("fill", "none");
        tempLine.setAttribute("stroke-dasharray", "5,5");
        svgContainer.appendChild(tempLine);
        document.addEventListener("mousemove", onTempLineMoveField); // —Ä–∏—Å—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ª–∏–Ω–∏—é
        document.addEventListener("mouseup", onTempLineEndField);    // –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—É—â–µ–Ω–∞ - —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    }

    // ------------------- –í—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è -------------------
    function onTempLineMoveField(e) {
        if (!connecting) return;
        const a = connecting.getBoundingClientRect();
        const cs = canvas.getBoundingClientRect();
        const x1 = a.right - cs.left;
        const y1 = a.top + a.height / 2 - cs.top;
        const x2 = e.clientX - cs.left;
        const y2 = e.clientY - cs.top;
        const midX = (x1 + x2) / 2;
        tempLine.setAttribute("d", `M${x1},${y1} L${midX},${y1} L${midX},${y2} L${x2},${y2}`);
    }

    // ------------------- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è -------------------
    function onTempLineEndField(e) {
        if (!connecting) return;
        const target = document.elementFromPoint(e.clientX, e.clientY);
        const targetLi = target.closest("li");
        if (targetLi && targetLi !== connecting) {
            connectFields(connecting, targetLi);
        }
        tempLine.remove();
        tempLine = null;
        connecting = null;
        document.removeEventListener("mousemove", onTempLineMoveField);
        document.removeEventListener("mouseup", onTempLineEndField);
    }

    // ------------------- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –ª–∏–Ω–∏–∏ -------------------
    function connectFields(fromLi, toLi, type = "one-to-many") {
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("stroke", "gray");
        path.setAttribute("stroke-width", "1");
        path.setAttribute("fill", "none");
        path.setAttribute("marker-start", "url(#many-start)");
        path.setAttribute("marker-end", "url(#many)");
        svgContainer.appendChild(path);

        // —Ö–∏—Ç-–∑–æ–Ω–∞ ‚Äî –Ω–µ–≤–∏–¥–∏–º–∞—è –ª–∏–Ω–∏—è –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –Ω–∞–≤–µ–¥–µ–Ω–∏—è
        const hitPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        hitPath.setAttribute("stroke", "transparent");
        hitPath.setAttribute("stroke-width", "8"); // —É–¥–æ–±–Ω–∞—è –∑–æ–Ω–∞
        hitPath.setAttribute("fill", "none");
        hitPath.setAttribute("pointer-events", "stroke"); // —á—Ç–æ–±—ã –ª–æ–≤–∏–ª–∞ —Å–æ–±—ã—Ç–∏—è
        svgContainer.appendChild(hitPath);

        // —É–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏ –ø–æ –∫–ª–∏–∫—É
        path.addEventListener("click", () => {
            if (confirm("–£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å?")) {
                const idx = connections.findIndex(c => c.path === path);
                if (idx !== -1) {
                    connections[idx].path.remove();         // —É–±—Ä–∞—Ç—å –∏–∑ DOM
                    connections.splice(idx, 1);  // —É–±—Ä–∞—Ç—å –∏–∑ –º–∞—Å—Å–∏–≤–∞
                    saveConnections();                      // –æ–±–Ω–æ–≤–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                }
            }
        });

        hitPath.addEventListener("mouseenter", () => {
            path.setAttribute("stroke", "#666");
            path.setAttribute("stroke-width", "2")
        });
        hitPath.addEventListener("mouseleave", () => {
            path.setAttribute("stroke", "gray");
            path.setAttribute("stroke-width", "1")
        });

        const rel = {from: fromLi, to: toLi, path, hitPath};
        connections.push(rel);

        updateConnection(rel);

        saveConnections();
    }

    // ------------------- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–∏ -------------------
    function updateConnection(rel) {
        const a = rel.from.getBoundingClientRect();
        const b = rel.to.getBoundingClientRect();
        const ws = canvas.getBoundingClientRect();
        const svg = document.getElementById('connections');

        const scrollWidth = ws.scrollWidth;
        const scrollHeight = ws.scrollHeight;
        svg.setAttribute('width', scrollWidth);
        svg.setAttribute('height', scrollHeight);
        svg.setAttribute('viewBox', `0 0 ${scrollWidth} ${scrollHeight}`); // üí• –ö–õ–Æ–ß!

        const x1 = a.right - ws.left + 0;
        const y1 = a.top + a.height / 2 - ws.top;
        const x2 = b.left;
        const y2 = b.top + b.height / 2 - ws.top;

        const verticalOffset = Math.abs(y2 - y1) / 2;
        const points = [];

        points.push([x1, y1]);

        if (x2 > x1 && ((x2 - x1) > 35)) {
            // —Ü–µ–ª—å —Å–ø—Ä–∞–≤–∞ ‚Äî –ø—Ä—è–º–æ–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç
            const midX = (x1 + x2) / 2;
            points.push([midX, y1]);
            points.push([midX, y2]);
        } else {
            // —Ü–µ–ª—å —Å–ª–µ–≤–∞ ‚Äî —Å—Ç—É–ø–µ–Ω—å–∫–∞
            const midX1 = x1 + 30;
            points.push([midX1, y1]);
            const midY = y1 < y2 ? y1 + verticalOffset : y1 - verticalOffset;
            points.push([midX1, midY]);
            const midX2 = x2 - 30;
            points.push([midX2, midY]);
            points.push([midX2, y2]);
        }

        points.push([x2, y2]);
        const d = points.map((p, i) => (i === 0 ? "M" : "L") + p[0] + "," + p[1]).join(" ");
        rel.path.setAttribute("d", d);
        rel.hitPath.setAttribute("d", d);
    }
    //********************************************************
    //                –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—å–µ–∫—Ç                //
    //********************************************************
    document.getElementById("addBlock").onclick = () => {

        createBlock();

        saveState();
    };


    function updateAllConnections() {
        connections.forEach(updateConnection);
    }

    function saveConnections(){

    }

    function saveState() {

    }

</script>

</body>
</html>
