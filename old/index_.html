<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Редактор</title>
  <style>
    body {
      font-family: sans-serif;
    }
    #workspace {
      position: relative;
      width: 800px;
      height: 500px;
      border: 2px solid #ccc;
      margin: 20px;
      background-image: linear-gradient(to right, #f5f5f5 1px, transparent 1px),
                        linear-gradient(to bottom, #f5f5f5 1px, transparent 1px);
      background-size: 10px 10px;

    }
    .block {
      position: absolute;
      width: 240px;
      /*height: 160px;*/
      /*background: #d6ebff;*/
      /*border: 1px solid #d0e0f5;*/
      /*cursor: grab;*/
      /*text-align: center;*/
      /*line-height: 60px;*/
      /*user-select: none;*/
      background: white;
      border: 1px solid #999;
      border-radius: 2px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
    }

    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #e6e6e6;
      padding: 6px 10px;
      font-weight: bold;
      cursor: move;
    }
    .block-header .title[contenteditable] {
      outline: none;
    }
    .delete-block { cursor: pointer; color: red; }

    .block.dragging {
      cursor: grabbing;
    }

    .delete-btn {
      position: absolute;
      top: 0; right: 0;
      width: 16px; height: 16px;
      background: red;
      color: white;
      font-weight: bold;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      cursor: pointer;
    }
    .add-field {
      display: block;
      width: 100%;
      padding: 5px;
      border: none;
      background: #e0e0e0;
      cursor: pointer;
    }
  </style>
</head>
<body>

<button onclick="addBlock()">Добавить блок</button>
<div id="workspace"></div>

<script>
const workspace = document.getElementById("workspace");
const gridSize = 10;
let blockCounter = 0;
let currentBlock = null;
let offsetX, offsetY;

function addBlock(x = 0, y = 0, id = null) {
  const block = document.createElement("div");
  block.className = "block";
  block.id = id || ("block-" + (++blockCounter));
  block.style.left = x + "px";
  block.style.top = y + "px";
  block.textContent = block.id;

// кнопка удаления
  const del = document.createElement('div');
  del.className = 'delete-btn';
  del.textContent = '×';
  del.onclick = (e) => {
    e.stopPropagation();
    removeBlock(block);
  };
  block.appendChild(del);

  block.innerHTML = `
        <div class="block-header">
          <span class="title" contenteditable="true">block-${blockCounter}</span>
          <span class="delete-block">×</span>
        </div>
        <button class="add-field">+ Добавить поле</button>
      `;

  block.querySelector(".delete-block").onclick = () => {
    block.remove();
    saveState();
  };

  block.addEventListener("mousedown", startDrag);
  workspace.appendChild(block);
  saveState();
}

function removeBlock(block) {
  // удаляем связи, связанные с блоком
  // connections = connections.filter(c => {
  //   if (c.from === block || c.to === block) {
  //     svg.removeChild(c.line);
  //     return false;
  //   }
  //   return true;
  // });
  // blocks = blocks.filter(b => b !== block);

  block.remove();
  saveState();
  adjustWorkspace();
}

function startDrag(e) {
  currentBlock = e.target;
  offsetX = e.clientX - currentBlock.offsetLeft;
  offsetY = e.clientY - currentBlock.offsetTop;

  currentBlock.classList.add("dragging");   // курсор "grabbing"

  document.addEventListener("mousemove", drag);
  document.addEventListener("mouseup", stopDrag);
}

function drag(e) {
  if (!currentBlock) return;
  let newLeft = e.clientX - offsetX;
  let newTop = e.clientY - offsetY;

  // Ограничение сверху и слева
  if (newLeft < 10) newLeft = 10;
  else newLeft = Math.round((newLeft - 10) / gridSize) * gridSize;

  if (newTop < 10) newTop = 10;
  else newTop = Math.round((newTop - 10) / gridSize) * gridSize;

  // Динамическое расширение вправо и вниз
  const requiredWidth = newLeft + currentBlock.offsetWidth;
  const requiredHeight = newTop + currentBlock.offsetHeight;

  if ((workspace.clientWidth - 10) < requiredWidth) {
    workspace.style.width = (requiredWidth + 10) + "px";
  }
  if ((workspace.clientHeight - 10) < requiredHeight) {
    workspace.style.height = (requiredHeight + 10) + "px";
  }

  currentBlock.style.left = newLeft + "px";
  currentBlock.style.top = newTop + "px";
}

function stopDrag() {
  if (currentBlock) {
    saveState();
  }
  currentBlock.classList.remove("dragging");   // курсор "grabbing"

  currentBlock = null;

  document.removeEventListener("mousemove", drag);
  document.removeEventListener("mouseup", stopDrag);
}

function saveState() {
  const blocks = [];
  document.querySelectorAll('.block').forEach(block => {
    blocks.push({
      id: block.id,
      left: block.style.left,
      top: block.style.top
    });
  });

  localStorage.setItem("workspaceState", JSON.stringify(blocks));
}

function adjustWorkspace() {
  const blocks = document.querySelectorAll('.block');
  let maxRight = 0;
  let maxBottom = 0;

  blocks.forEach(block => {
    const right = block.offsetLeft + block.offsetWidth;
    const bottom = block.offsetTop + block.offsetHeight;
    if (right > maxRight) maxRight = right;
    if (bottom > maxBottom) maxBottom = bottom;
  });

  // Подгоняем ширину и высоту, если текущая меньше
  if (workspace.clientWidth < maxRight + 10) {
    workspace.style.width = (maxRight + 10) + "px";
  }
  if (workspace.clientHeight < maxBottom + 10) {
    workspace.style.height = (maxBottom + 10) + "px";
  }
}
function loadState() {
  const saved = localStorage.getItem("workspaceState");
  if (saved) {
    const blocks = JSON.parse(saved);
    blocks.forEach(data => {
      // достаём id, чтобы при восстановлении не дублировать
      addBlock(parseInt(data.left), parseInt(data.top), data.id);
    });
  }

  adjustWorkspace();
}

window.onload = loadState;
</script>
</body>
</html>
